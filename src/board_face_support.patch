From: Cyan Bot <bot@cyan.app>
Subject: [PATCH] Add board face support (canvas/notebook/notes)

This patch updates the board mode system to support three faces:
- canvas (replaces freeform) - whiteboard/drawing
- notebook - Jupyter-style cells
- notes - VSCode-style text editor

---
 src/lib.rs | 45 +++++++++++++++++++++++++++------------------
 1 file changed, 27 insertions(+), 18 deletions(-)

diff --git a/src/lib.rs b/src/lib.rs
index 1234567..abcdefg 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -580,9 +580,14 @@ fn run_migrations(conn: &Connection) -> Result<()> {
     // Check and add board_mode column to objects
     if conn.prepare("SELECT board_mode FROM objects LIMIT 1").is_err() {
-        tracing::info!("Migration: adding board_mode column to objects");
-        let _ = conn.execute("ALTER TABLE objects ADD COLUMN board_mode TEXT DEFAULT 'freeform'", []);
+        tracing::info!("Migration: adding board_mode column to objects (default: canvas)");
+        let _ = conn.execute("ALTER TABLE objects ADD COLUMN board_mode TEXT DEFAULT 'canvas'", []);
     }
+
+    // Migrate existing 'freeform' values to 'canvas'
+    let _ = conn.execute("UPDATE objects SET board_mode = 'canvas' WHERE board_mode = 'freeform'", []);
+    let _ = conn.execute("UPDATE objects SET board_mode = 'canvas' WHERE board_mode IS NULL", []);
+
     // Check and create board_metadata table if not exists
     if conn.prepare("SELECT board_id FROM board_metadata LIMIT 1").is_err() {
         tracing::info!("Migration: creating board_metadata table");
@@ -4749,14 +4754,18 @@ pub extern "C" fn cyan_get_notebook_state(board_id: *const c_char) -> *mut c_cha
     CString::new(json).unwrap().into_raw()
 }

-/// Get board mode (freeform or notebook)
+/// Get board mode (canvas, notebook, or notes)
 #[unsafe(no_mangle)]
 pub extern "C" fn cyan_get_board_mode(board_id: *const c_char) -> *mut c_char {
     let Some(sys) = SYSTEM.get() else {
-        return CString::new("freeform").unwrap().into_raw();
+        return CString::new("canvas").unwrap().into_raw();
     };

     let bid = unsafe { CStr::from_ptr(board_id) }.to_string_lossy().to_string();

     let mode: String = {
         let db = sys.db.lock().unwrap();
-        db.query_row(
-            "SELECT COALESCE(board_mode, 'freeform') FROM objects WHERE id = ?1",
+        let raw_mode: String = db.query_row(
+            "SELECT COALESCE(board_mode, 'canvas') FROM objects WHERE id = ?1",
             params![bid],
             |row| row.get(0)
-        ).unwrap_or_else(|_| "freeform".to_string())
+        ).unwrap_or_else(|_| "canvas".to_string());
+
+        // Normalize legacy 'freeform' to 'canvas'
+        if raw_mode == "freeform" { "canvas".to_string() } else { raw_mode }
     };

     CString::new(mode).unwrap().into_raw()
 }

-/// Set board mode (freeform or notebook)
+/// Set board mode (canvas, notebook, or notes)
 #[unsafe(no_mangle)]
 pub extern "C" fn cyan_set_board_mode(board_id: *const c_char, mode: *const c_char) -> bool {
     let Some(sys) = SYSTEM.get() else {
         return false;
     };

     let bid = unsafe { CStr::from_ptr(board_id) }.to_string_lossy().to_string();
     let mode_str = unsafe { CStr::from_ptr(mode) }.to_string_lossy().to_string();

-    if mode_str != "freeform" && mode_str != "notebook" {
+    // Normalize legacy 'freeform' to 'canvas'
+    let normalized_mode = if mode_str == "freeform" {
+        "canvas".to_string()
+    } else {
+        mode_str.clone()
+    };
+
+    // Validate mode
+    if normalized_mode != "canvas" && normalized_mode != "notebook" && normalized_mode != "notes" {
+        tracing::warn!("Invalid board mode: {}", normalized_mode);
         return false;
     }

     let group_id: String;

     {
         let db = sys.db.lock().unwrap();

         group_id = db.query_row(
             "SELECT w.group_id FROM objects o
              JOIN workspaces w ON o.workspace_id = w.id
              WHERE o.id = ?1",
             params![&bid],
             |row| row.get(0)
         ).unwrap_or_default();

         if db.execute(
             "UPDATE objects SET board_mode = ?1 WHERE id = ?2",
-            params![&mode_str, &bid]
+            params![&normalized_mode, &bid]
         ).is_err() {
             return false;
         }
     }

     if !group_id.is_empty() {
         let event = NetworkEvent::BoardModeChanged {
             board_id: bid.clone(),
-            mode: mode_str.clone(),
+            mode: normalized_mode.clone(),
         };

         let _ = sys.network_tx.send(NetworkCommand::Broadcast {
             group_id,
             event,
         });
     }

     true
 }
--
2.39.0